# Ethereum Casper and Proof-of-Stake

[Ethereum](ethereum.org)은 합의 알고리즘의 업데이트를 예고하며, Ethereum Casper라고 불리는 새로운 프로토콜을 제시했다. 이는 [Ethereum Serenity](https://blog.ethereum.org/2015/12/24/understanding-serenity-part-i-abstraction/) 하드포크 이후부터 점차 적용될 예정이다.
캐스퍼는 요약하면 기존 PoW 방식의 이더리움을 PoS 방식으로 전환하게 해주는 PoS 알고리즘이다. 캐스퍼가 무엇인지 자세히 알아보기 전에, PoW와 PoS가 뭔지부터 짚어보자.

## Proof-of-work (작업증명)
[Bitcoin](bitcoin.org)을 시작으로 한 다수의 암호화폐는 작업증명 방식을 채택한다. 작업증명은 비잔틴 장군의 문제를 일정 난이도의 암호를 풀어서 해결하는 방식이다. 이 방식을 통해 블록체인은 신뢰성과 일관성을 유지할 수 있다.

* 채굴자는 블록체인에서 다음 블록을 만들기 위해 암호 문제를 푼다.
* 암호 문제를 풀기 위해선 반드시 컴퓨팅 비용이 소모된다. (전기 등...)
* 문제를 풀어낸 채굴자의 블럭만이 다음 블럭으로 인정되고, 보상을 가져간다.

### 신뢰성
만약에 악의적인 공격자 A가 자신의 계좌에 1000만원을 입금하는 허위 거래를 생성할려고 시도한다고 생각해보자.  
A는 허위 거래가 담긴 블럭을 생성하고, 이를 정식 거래로 인정받기 위해 체인에 추가할려고 시도할 것이다. 하지만 PoW 방식 하에선 다음과 같은 원리로 이런 공격이 차단된다.

* A는 블럭을 추가하기 위해 암호 문제를 풀어야 하기 때문에, **실제 컴퓨팅 비용이 지불**된다.
	* 따라서 A가 행사할 수 있는 공격력에는 한계가 생기게 된다.
* A가 문제를 풀지 못한다면, A가 만든 블럭은 정식 블럭으로 인정받지 못한다.
* 만약 A가 우연히 문제를 풀고, 드디어 허위거래 블록을 메인 체인에 추가하는데 성공했다면 어떻게 될까?
	* 블록체인에는 순간적으로 A의 브랜치와, 그와 대립되는 정상 브랜치가 생긴다. 
	* 하지만 A를 제외한 나머지 채굴자들은 정상 브랜치를 가지고 있다.
	* A가 앞으로 계속 블록을 생성하는데 성공하지 않는 한, A의 브랜치는 **다음번 블록 생성때 덮어씌어져 무시될 것이다.** 
	* Nakamoto Satoshi는 블록 6개가 연속으로 대립되는 상황이 나올 확률이 0에 수렴한다는 것을 [증명했다](https://bitcoin.org/bitcoin.pdf).

결국 공격자는 과반수 (51%) 이상의 참여를 이끌어내지 않는 이상 블록을 위변조할 수 없다.

### 일관성
탈중앙화된 블록체인 네트워크에서의 문제는 거래와 블록 업데이트가 전세계에서 동시다발적으로 진행된다는 것이다.  
만약 다른 내용을 담은 블록이 동시에 만들어진다면 어떤 블록을 믿어야 할 것인가? 이렇게 블록의 동시생성이 가능해진다면 네트워크의 일관성은 깨져버린다. 이 문제를 PoW는 암호 문제를 푼 채굴자의 블록만 인정함으로서, 동시생성 가능성을 차단해 일관성을 유지시킨다.

## Proof-of-work의 문제
PoW는 이렇게 컴퓨팅 비용을 소모하는 방식으로 BFT (Byzantine Fault Torelance)를 보장한다. 하지만 문제가 생긴다.

* 합의를 위해 소모되는 에너지가 너무 크다. 
* 컴퓨팅 파워를 특정 세력이 행사함으로서, 해시 파워에 빈부격차가 생긴다.

에너지 비효율성 문제는 비트코인의 채굴에 사용되는 에너지 양이 한 국가가 사용하는 에너지 양보다 더 많아질 정도로 심각해진 상황이며, 해시 파워의 빈부격차로 인해 상위 5개 마이닝 풀이 비트코인 해시파워의 65%를 차지해버리게 되었다. 그 결과로, PoW에 기반한 비트코인 네트워크는 탈중앙화되었다고 부르기도 힘든 전기먹는 하마가 되어버렸다.

이러한 PoW의 대안으로, PoS (Proof-of-stake) 방식의 합의 알고리즘이 제시되었다.

## Proof-of-Stake (자산증명)
PoS는 컴퓨팅 파워를 낭비하는 대신, 자신이 가진 자산 (Stake)를 통해 블럭을 생성한다. 채굴자 대신 검증자 (Vaildator)가 자신의 자산을 담보로 잡고 참여해, 가상으로 채굴 작업을 구현한다.

* 검증자들은 자신의 자산 일부를 담보로 잡는다.
* 검증자들은 어떤 블록이 체인에 추가될지 자신의 자산에 비례하는 만큼 투표할수 있다. 
* 투표에 의해 다음 블록이 선출되고, 해당 블록에 투표한 검증자들은 표에 비례해 보상을 받는다.

악의적인 공격자가 공격을 시도하더라도, 네트워크의 나머지 다수 검증자에 비해 지분이 부족하기 때문에 공격은 실패할 것이다.  
또한 제일 표를 많이 받은 블록만이 다음 블록으로 인정되므로 블록이 동시 생성이 불가능해진다. 

이렇게 PoS는 효율적으로 신뢰성과 일관성을 잡았다! 하지만 정말 그럴까?

### PoS의 문제 : "Nothing at Stake" Problem
악의적인 공격자 A의 문제로 돌아가보자. A는 악의적인 블럭을 생성해 새로운 A 브랜치를 만들려고 시도한다.  
이제 네트워크엔 두개의 브랜치가 존재한다. 이 상황에서 신뢰성을 유지할려면 어떻게 해야 할까?

PoW 방식에서는 문제가 없다. A 브랜치를 유지할려면 과반수 이상의 참여가 필요한데, 다른 채굴자들은 선택될 가능성도 없고 이득도 별로 없는 A 브랜치를 채굴해 돈을 낭비할 이유가 전혀 없다. 결국 A 브랜치는 외면받은채로 사라질 것이다. 

PoS는 한가지 문제가 생긴다. **잘못된 브랜치에 투표하더라도 손해를 보지 않는다.** 만약 검증자가 두가지 브랜치 모두에 투표하더라도 검증자는 A 브랜치가 선출되든 메인 브랜치가 선출되든 전혀 손해를 볼 것이 없다. 이렇게 PoS는 악의적인 브랜치더라도, 무관심한 검증자들에 의해 해당 브랜치가 유지되어버릴 가능성이 생긴다. 이를 잃을 게 없는 (Nothing at Stake) 문제라고 부른다.

이러한 문제를 해결하기 위해, 다양한 방식의 PoS 알고리즘이 제안되었다. 그중 Casper에 대해 다뤄보자.

## Ethereum Casper
Casper는 이더리움만의 PoS 구현 프로토콜이다. Casper가 다른 PoS 알고리즘과 차별되는 점은 바로 **처벌**이다.

* 검증자들은 자신이 가진 일정량의 이더리움을 담보로 잡는다.
* 검증자들은 어떤 블록이 체인에 추가될지 투표한다. 
* 다음 블록이 선출되고, 해당 블록에 투표한 검증자들은 자신의 담보 자산에 비례해 보상을 얻는다.
* **잘못된 블록에 투표한 검증자들은, 담보로 건 이더리움을 전부 잃는 처벌을 받는다.**

이제 생각 없이 잘못된 블록에 투표하거나, 공격을 시도하는 공격자들은 잃을 것이 생기게 된다. 공격은 대규모의 자산을 필요로 하면서 동시에 그 자산을 잃을 리스크 또한 가지게 되므로 공격 시도조차 힘들어진다. 여기에 추가적으로 캐스퍼는 노드를 오프라인 상태로 유지하는 "게으른" 검증자들에 대해서도 처벌하므로, 검증자들의 지속적인 업타임까지 보장되게 된다.

### 분산화 (Sharding)의 가능성
이더리움이 Casper를 통해 PoS로 넘어가면 생기는 또 하나의 장점은 샤딩이 용이해진다는 것이다.  
샤딩을 하게 된다면 여러개의 크고 작은 네트워크가 생기게 되는데, 기존 PoW 방식에서는 작은 네트워크가 큰 채굴자들에 의해 쉽게 점유당할 수 있다는 문제점이 있다. 하지만 PoS 방식에서는 공격 가능성이 감소되기 때문에 신뢰성 있는 샤딩이 가능해진다.

### PoS 방식이 오히려 중앙화를 일으키진 않을까?
PoS 방식과 Casper에 대한 설명을 읽으면 한가지 생각을 할 수 있을 것이다. 

> 자신의 자산 보유량에 의해 블록 검증에 대한 권력과 보상이 결정되는 건, 오히려 부익부 빈익빈을 일으켜 중앙화를 촉진시키지 않을까?  

하지만 자산 보유량이 과반수가 되기는 쉽지가 않다. 일단 현재 이더리움 보유량 지분은 상당히 분산되어 있으므로, 이들이 과반수 이상의 권력을 행사하려면 마이닝 풀과 같이 풀을 만들어야 하지만 이는 쉽지 않다. 해시파워를 합치는 PoW 마이닝 풀과 달리 PoS에서는 자산을 합쳐야 하는데, 이는 신뢰의 문제 및 자산 상실의 문제로 인해 경제적으로 쉽지가 않다. 

PoS에선 중앙화가 되더라도 PoW에 비해 해가 적은 것도 장점이다. 과반수 공격을 복구하는 것이 PoW보다 PoS에서  훨씬 쉽고 저렴하기 때문이다.

### Casper로의 전환을 위해 : Casper FFG (Friendly Finality Gadget)
당연히 이러한 PoS 방식으로의 전환은 기존 채굴자들과 커뮤니티의 반발을 불러일으키기 쉽다. 그래서 이더리움은 Casper 전환 전에, Casper FFG라는 PoS/PoW 하이브리드 방식을 먼저 도입하기로 예정되어 있다.

Casper FFG는 PoW 방식을 유지하면서 매 50번째 블럭마다 PoS Checkpoint를 두고 투표를 함으로서, PoW 위에 PoS를 구현한다. 이 과도기적인 방식을 통해 PoW의 신뢰성을 강화함과 동시에 PoS로의 전환을 도모할 수 있다.


## 출처
* [Proof of Stake FAQ · ethereum/wiki Wiki · GitHub](https://github.com/ethereum/wiki/wiki/Proof-of-Stake-FAQ)
* [A Proof of Stake Design Philosophy – Vitalik Buterin – Medium](https://medium.com/@VitalikButerin/a-proof-of-stake-design-philosophy-506585978d51) 
* [작업증명(PoW, Proof-of-work)과 지분증명(PoS, Proof-of-stake) – theloop](https://blog.theloop.co.kr/2017/06/01/%EC%9E%91%EC%97%85%EC%A6%9D%EB%AA%85pow-proof-of-work%EA%B3%BC-%EC%A7%80%EB%B6%84%EC%A6%9D%EB%AA%85pos-proof-of-stake/)
* [What is Ethereum Casper Protocol? Crash Course - Blockgeeks](https://blockgeeks.com/guides/ethereum-casper/)
